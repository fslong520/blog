<p class="uk-text-right"><i>本文对Python使用多线程、多进程、异步IO进行对比</i></p>
<p>  笔者的开发环境是Windows10，部署使用的是Windows10的Linux子系统（WSL），这样省了很多麻烦，前面的文章也介绍过类似的的内容，这里不再赘述。顺便提一下，目前Linux子系统已经有很多，包括有Ubuntu、openSUSE、SUSE Linux、Debian、Kali等，笔者由于习惯的原因，使用的是Debian。今天对Python使用多线程、多进程、异步IO进行了对比，首先先上代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
# -*- coding: utf-8 -*-
</span>
<span class="s">' 多进程、多线程、异步io学习 '</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">'fslong'</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">'0.0.1'</span>

<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">threading</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">queue</span>


<span class="k">def</span> <span class="nf">job</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'子线程/子进程:</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'线程数量:'</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">active_count</span><span class="p">())</span>
    <span class="c1">#print('线程:', threading.current_thread())
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="n">i</span>
    <span class="c1">#time.sleep(3)
</span>    <span class="k">return</span> <span class="n">j</span>


<span class="k">def</span> <span class="nf">job1</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'子线程/子进程:</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'线程数量:'</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">active_count</span><span class="p">())</span>
    <span class="c1">#print('线程:', threading.current_thread())
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="n">i</span>
    <span class="c1">#time.sleep(3)
</span>    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">j</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">yibu</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'子线程/子进程:</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'线程数量:'</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">active_count</span><span class="p">())</span>
    <span class="c1">#print('线程:', threading.current_thread())
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="n">i</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">mp</span><span class="p">():</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">loop</span><span class="p">():</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">job1</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">q</span><span class="p">,</span>
            <span class="p">))</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>        
        <span class="n">i</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">yibuIo</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="n">task</span> <span class="o">=</span> <span class="p">[</span><span class="n">yibu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>    
    <span class="k">return</span> <span class="n">result</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    
    <span class="n">start1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
        <span class="c1">#print(result)
</span>    <span class="n">end1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>    

    <span class="n">start2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">mp</span><span class="p">()</span>
        <span class="c1">#print(mp())
</span>    <span class="n">end2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    
    <span class="n">start3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">loop</span><span class="p">()</span>
        <span class="c1">#print(loop())
</span>    <span class="n">end3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    

    <span class="n">start4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">yibuIo</span><span class="p">()</span>
        <span class="c1">#print(yibuIo())
</span>    <span class="n">end4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'采用单线程执行了10次耗时：</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">end1</span> <span class="o">-</span> <span class="n">start1</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'采用多线程执行了10次耗时：</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">end3</span> <span class="o">-</span> <span class="n">start3</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'采用多进程执行了10次耗时：</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">end2</span> <span class="o">-</span> <span class="n">start2</span><span class="p">))</span>    
    <span class="k">print</span><span class="p">(</span><span class="s">'采用异步IO执行了10次耗时：</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">end4</span> <span class="o">-</span> <span class="n">start4</span><span class="p">))</span>
    <span class="c1">#input()
</span>
</code></pre></div></div>
<p>将上面的代码分别在win10的cmd中以及wsl中执行，执行结果（多次执行，结果基本一致）如下图：<br />
<img src="https://i.loli.net/2018/08/14/5b726e9975f62.png" alt="python多任务对比.png" /><!--删除连接：https://sm.ms/delete/PRCcJ1DUykwpVES--> <br />
笔者电脑cpu是i3 3210m，双核四线程的配置。执行期间观察任务管理器结果如下：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left"> </th>
      <th style="text-align: center">单线程</th>
      <th style="text-align: center">多进程</th>
      <th style="text-align: center">多线程</th>
      <th style="text-align: center">异步IO</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">cpu占用</td>
      <td style="text-align: center">1×30%左右</td>
      <td style="text-align: center">4×8%左右</td>
      <td style="text-align: center">1×30%左右</td>
      <td style="text-align: center">1×29左右</td>
    </tr>
  </tbody>
</table>

<p>上表可见这堆代码其实也已经占满了一个核心的计算能力。</p>

<h3 id="结论">结论</h3>
<p>从上图我们可以看出来以下几点：</p>
<ol>
  <li>在win10下直接执行python脚本速度反而没有在wsl（Linux环境）中快；</li>
  <li>单线程在win10和wsl（Linux环境）中运行差别不大；</li>
  <li>多线程、多进程、异步io，运行速度wsl（Linux环境）中普遍要比win10中快10%左右，这有可能跟代码有关；</li>
  <li>wsl（Linux）环境下多线程和多进程速度基本一致，在win10下多线程明显要比多进程快，据大佬解释，Windows环境下多线程能力要强一些，单核性能十分重要，这也就是为何amd的cpu那么多核还被Intel的cpu吊打的原因，实验结果也符合预期结果；</li>
  <li>由于Python的语言特性，异步IO没有多线程任务切换期间的资源消耗，导致使用异步IO实现多并发执行速度最快，win10和wsl（Linux环境）均有如此结果，尤其是在wsl（Linux）环境下尤为突出，比单线程速度提升大约15%。</li>
</ol>

<h3 id="思考">思考</h3>
<ol>
  <li>上述代码主要是多任务类型，有大量的IO吞吐，而不是计算密集型，由于Python有gil锁，导致多线程以及异步IO只能利用一颗CPU，这种情况下使用异步IO有很大的优势，实际工程中比如网络应用之类主要就是这种类型；</li>
  <li>如果遇到计算密集型，比如迭代，科学计算，矩阵，神经网络计算之类的，如果还使用一个核的话浪费了太多资源，这时就可以体现出多进程的优势；</li>
  <li>如果追求最大限度的性能，可以使用<strong>多进程+异步IO</strong>结合的方式。</li>
</ol>
